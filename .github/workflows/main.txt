name: Deploy wizzdigital

on:
  push:
    branches: [main]

jobs:
  build_and_push:
    name: Build & Push Docker images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_RW }}
          
      - name: Build & Push Backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend/
          push: true
          tags: egorovdocker/wizzdigital_backend:latest
          
      - name: Build & Push Gateway
        uses: docker/build-push-action@v6
        with:
          context: ./gateway/
          push: true
          tags: egorovdocker/wizzdigital_gateway:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.yml
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          timeout: 60s
          source: "docker-compose.production.yml"
          target: "wizzdigital"
          
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            set -e
            cd wizzdigital

            echo "${{ secrets.DOCKERHUB_TOKEN_RO }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            sudo docker compose -f docker-compose.production.yml down --remove-orphans || true

            # ÐŸÐ¾Ð´Ñ‚ÑÐ³Ð¸Ð²Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
            sudo docker compose -f docker-compose.production.yml pull

            # ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹
            sudo docker compose -f docker-compose.production.yml up -d

            # Ð–Ð´Ñ‘Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
            sleep 10

            # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ
            sudo docker compose -f docker-compose.production.yml ps

            # === Ð§Ð˜Ð¡Ð¢ÐšÐ ===
            
            # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð’Ð¡Ð• Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸)
            sudo docker image prune -af
            
            # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, ÑÐµÑ‚Ð¸, ÐºÑÑˆ
            sudo docker system prune -f
            
            # ÐžÐ±Ñ€ÐµÐ·Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´Ð¾ 10MB)
            for log in /var/lib/docker/containers/*/*-json.log; do
              sudo truncate -s 10M "$log" 2>/dev/null || true
            done
            
            # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð»Ð¾Ð³Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (ÑÑ‚Ð°Ñ€ÑˆÐµ 30 Ð´Ð½ÐµÐ¹)
            sudo find /var/log -name "*.log" -mtime +30 -delete 2>/dev/null || true
            
            # ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ systemd journal (Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ 100MB)
            sudo journalctl --vacuum-size=100M 2>/dev/null || true

            echo "âœ… Deployed and cleaned!"

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "ðŸŽ‰ wizzdigital deployed! Commit: ${{ github.sha }}"