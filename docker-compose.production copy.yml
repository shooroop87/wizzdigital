volumes:
  pg_data_production:
  static_volume:
  media:
  redis_data:

services:
  db:
    image: postgres:13.10
    env_file: .env
    volumes:
      - pg_data_production:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  redis:
    image: redis:7
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  backend:
    # ЯВНЫЙ тег и автоподтягивание
    image: egorovdocker/wizzdigital_backend:latest
    pull_policy: always
    env_file: .env
    volumes:
      - static_volume:/app/collected_static
      - media:/app/media/
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    # entrypoint теперь внутри образа — ничего переопределять не надо
    restart: unless-stopped

  # Автообновление данных трансферов каждые 12 часов
  transfers-updater:
    # Используем тот же образ, но ВАЖНО: гасим entrypoint бэкенда
    image: egorovdocker/wizzdigital_backend:latest
    pull_policy: always
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    # <<< переопределяем entrypoint, чтобы НЕ бежали migrate/collectstatic >>>
    entrypoint: ["/bin/sh", "-c"]
    command: >
      echo 'Setting up automatic transfers updater...' &&
      printf '0 6 * * * cd /app && python manage.py refresh_all_transfers --clear-cache >> /tmp/transfers.log 2>&1\n' > /tmp/crontab &&
      printf '0 18 * * * cd /app && python manage.py refresh_all_transfers >> /tmp/transfers.log 2>&1\n' >> /tmp/crontab &&
      crontab /tmp/crontab &&
      echo 'Cron jobs installed. Transfers will auto-update at 6:00 and 18:00 daily.' &&
      crond -f -l 2
    restart: unless-stopped

  gateway:
    image: egorovdocker/wizzdigital_gateway:latest
    pull_policy: always
    env_file: .env
    volumes:
      # Раздаём статику только для чтения
      - static_volume:/staticfiles:ro
      # Медиа раздаём из общего тома тоже read-only
      - media:/app/media/:ro
    ports:
      - "8000:80"
    depends_on:
      - backend
    restart: unless-stopped

  # === СЕРВИСЫ ОБСЛУЖИВАНИЯ ===
  # (оставляю без изменений функционально)

  redis-cleaner:
    image: redis:7
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
    restart: "no"
    profiles: ["maintenance"]
    command: >
      sh -c "
        echo 'Starting Redis cache cleanup...' &&
        echo 'NOTE: consider using SCAN instead of KEYS in production for large datasets.' &&
        redis-cli -h redis KEYS 'cache:*' | xargs -r -n 1000 redis-cli -h redis DEL || true &&
        echo 'Redis cache cleaned'
      "

  db-backup:
    image: postgres:13.10
    env_file: .env
    volumes:
      - ./backups:/backups
    depends_on:
      db:
        condition: service_healthy
    restart: "no"
    profiles: ["maintenance"]
    command: >
      sh -c "
        echo 'Creating database backup...' &&
        pg_dump -h db -U ${POSTGRES_USER:-postgres} ${POSTGRES_DB:-wizzdigital} > /backups/backup_$(date +%Y%m%d_%H%M%S).sql &&
        echo 'Database backup created' &&
        find /backups -name 'backup_*.sql' -mtime +7 -delete &&
        echo 'Old backups cleaned up'
      "

  file-cleaner:
    image: alpine:latest
    volumes:
      - media:/app/media/
      - ./logs:/app/logs
    restart: "no"
    profiles: ["maintenance"]
    command: >
      sh -c "
        echo 'Cleaning old files...' &&
        find /app/media/temp -type f -mtime +7 -delete 2>/dev/null || true &&
        find /app/logs -name '*.log' -mtime +30 -delete 2>/dev/null || true &&
        echo 'File cleanup completed'
      "

  system-monitor:
    image: alpine:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: "no"
    profiles: ["monitoring"]
    command: >
      sh -c "
        apk add --no-cache docker-cli &&
        echo 'System Resource Usage:' &&
        docker stats --no-stream --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}' &&
        echo '' &&
        echo 'Volume Usage:' &&
        docker system df -v | grep -E '(VOLUME NAME|wizzdigital)' || true
      "

  docker-cleaner:
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: "no"
    profiles: ["maintenance"]
    command: >
      sh -c "
        echo 'Cleaning Docker system...' &&
        docker system prune -f &&
        echo 'Docker system cleaned'
      "
